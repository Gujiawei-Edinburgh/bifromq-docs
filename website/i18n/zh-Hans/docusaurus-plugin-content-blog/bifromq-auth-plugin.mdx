---
slug: AnyAuth and Integration with BifroMQ
title: "AnyAuth与BifroMQ的集成"
tags: [Auth, Plugin]
---

import ReactPlayer from 'react-player'

**AnyAuth**插件根据BifroMQ `IAuthProvider`接口使用PF4J构建的插件服务。它旨在为BifroMQ提供无缝的身份验证和授权功能，使用户能够安全地访问各种
客户端上的消息和资源。

<!--truncate-->

**AnyAuth**插件支持多种身份验证机制，包括服务于设备的用户名/密码，服务于用户的auth0和微信。这意味着用户可以使用其喜欢的社交账户进行身份进行登录，
简化了对BifroMQ的访问。

此外，**AnyAuth**通过ACL提供基于角色的访问控制（RBAC）。此功能使用户能够定义不同的角色和权限，从而确保精细的访问控制。

要了解更多信息和技术设计，请查看 [文章](https://github.com/Gujiawei-Edinburgh/bifromq-plugin-anyAuth#readme).
## 设置步骤
将**AnyAuth**集成到BifroMQ中，只需要按照如下步骤即可：

### 前提条件
需要注意的是**AnyAuth**仅查询设备的credentials和相关的ACL规则。设备注册（确定用户名和密码）和ACL的指定等管理类任务由其他服务处理。因此
为了避免**AnyAuth**查询不到数据，需要用户先完成设备的注册和ACL的制定。

### AnyAuth插件配置信息

由于**AnyAuth**支持多种认证方式（即：username/password，auth0和微信），因此需要对每一种认证方式配置好对应的参数。配置文件放置于
`bifromq-plugin-anyAuth/auth-plugin/src/main/resources` 文件夹中，并且会打包置于产出JAR中。因此需要在编译前，指定好对应的参数。
```yaml
tenantId: ${TENANTID}
device:
  authUrl: ${AUTH_SERVICE_AUTH_URL}
  checkUrl: ${AUTH_SERVICE_CHECK_URL}
auth0:
  domain: ${AUTH0_DOMAIN}
wechat:
  appId: ${APP_ID}
  appSecret: ${APP_SECRET}
  requestUrl: https://api.weixin.qq.com/sns/jscode2session?appid=
```
### 链接BifroMQ与插件
进入到**AnyAuth**工程目录并执行以下命令获得对应的编译产出:
```mvn
cd bifromq-plugin-anyAuth && mvn clean package
```
该命令会生成 `auth-plugin-${VERSION}.jar` and `auth-service-${VERSION}.tar.gz`在各自的`target`文件夹中。

为了保证BifroMQ可以正确地加载**AnyAuth**插件, 用户需要将JAR放置于正确的文件夹目录下, 即： `bifromq-${VERSION}/plugins`。 此外在
BifroMQ配置文件中（`conf/standalone.yml`）还需要指定Fully Qualified Name (FQN)，
例如：`authProviderFQN: bifromq.plugin.auth.AuthProvider`。

### 设置AnyAuth服务
插件中的JAR部分在认证鉴权过程中充当了客户端的角色，对于数据库的查询操作则由**AnyAuth**服务来处理。部署**AnyAuth**服务时，用户需要制定其所用的MySQL
的连接信息。

对于部分测试和开发场景, **AnyAuth**还支持dummy storage的方式，将配置中的`type`设置成`Dummy`即可。

## 端到端的示例
在完成了全部的设置之后，用户可以使用微信小程序登录BifroMQ，用图形化程序来模拟设备。例如视频展示了以下的一个典型场景：设备通过BifroMQ上报温度信息，
小程序收到对应的消息之后，根据上报的温度来下发不同的命令。
<div className="video__wrapper">
    <ReactPlayer className="video__player" controls height="100%"
    url="https://github.com/Gujiawei-Edinburgh/bifromq-plugin-anyAuth/assets/55412783/df9f9009-e96f-4c97-b25a-aa399196fbd9"
    width="100%" />
</div>